<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files - Marlyg Client Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <h1 class="text-xl font-bold text-gray-800">Marlyg Client Portal</h1>
                    <a href="/dashboard" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>Dashboard
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-name" class="text-gray-600"></span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">File Manager</h2>
                <p class="mt-2 text-gray-600">Upload and manage your files</p>
            </div>
            <button onclick="document.getElementById('file-input').click()" 
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-upload mr-2"></i>Upload File
            </button>
        </div>

        <!-- Upload Form (Hidden) -->
        <input type="file" id="file-input" class="hidden" onchange="uploadFile()">

        <!-- Upload Progress -->
        <div id="upload-progress" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 hidden">
            <div class="flex items-center justify-between">
                <span class="text-blue-700">Uploading...</span>
                <span id="upload-percent" class="text-blue-700 font-semibold">0%</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                <div id="upload-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- Message -->
        <div id="message" class="p-4 rounded-lg mb-6 hidden"></div>

        <!-- Files Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                File Name
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Size
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Uploaded
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="files-tbody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                Loading files...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin + '/api';
        const token = localStorage.getItem('session_token');

        if (!token) {
            window.location.href = '/';
        }

        function showMessage(text, type = 'info') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `p-4 rounded-lg mb-6 ${
                type === 'error' ? 'bg-red-100 text-red-700' :
                type === 'success' ? 'bg-green-100 text-green-700' :
                'bg-blue-100 text-blue-700'
            }`;
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 5000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function fetchUser() {
            const response = await fetch(`${API_BASE}/user`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                localStorage.removeItem('session_token');
                window.location.href = '/';
                return;
            }

            const { user } = await response.json();
            document.getElementById('user-name').textContent = user.name || user.email;
        }

        async function fetchFiles() {
            const response = await fetch(`${API_BASE}/files`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const { files } = await response.json();
            const tbody = document.getElementById('files-tbody');
            
            if (files.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">No files yet. Upload your first file!</td></tr>';
                return;
            }

            tbody.innerHTML = files.map(file => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                            <div class="text-sm font-medium text-gray-900">${file.filename}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatBytes(file.file_size || 0)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(file.uploaded_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <a href="${API_BASE}/download/${file.id}" 
                            class="text-blue-600 hover:text-blue-900 mr-4">
                            <i class="fas fa-download mr-1"></i>Download
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        async function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-bar');
            const progressPercent = document.getElementById('upload-percent');

            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressPercent.textContent = percent + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        showMessage('File uploaded successfully!', 'success');
                        fetchFiles();
                        fileInput.value = '';
                    } else {
                        showMessage('Upload failed. Please try again.', 'error');
                    }
                    progressDiv.classList.add('hidden');
                });

                xhr.addEventListener('error', () => {
                    showMessage('Network error during upload', 'error');
                    progressDiv.classList.add('hidden');
                });

                xhr.open('POST', `${API_BASE}/upload`);
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.send(formData);
            } catch (error) {
                showMessage('Upload failed. Please try again.', 'error');
                progressDiv.classList.add('hidden');
            }
        }

        function logout() {
            fetch(`${API_BASE}/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            localStorage.removeItem('session_token');
            window.location.href = '/';
        }

        // Load data
        fetchUser();
        fetchFiles();
    </script>
</body>
</html>
